<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shoulder MRI MPR Viewer - RadMentor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .viewport {
            width: 100%;
            height: 100%;
            background-color: black;
            border-radius: 0.375rem; /* rounded-md */
        }
        .rad-gradient {
            background: linear-gradient(90deg, #1e40af, #3b82f6);
        }
        .tool-btn {
            background-color: #e5e7eb;
            color: #374151;
            transition: all 0.2s ease-in-out;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tool-btn:hover {
            background-color: #d1d5db;
        }
        .tool-btn.active {
            background: linear-gradient(90deg, #1e40af, #3b82f6);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(0, 118, 255, 0.39);
        }
        #anatomy-list {
            scrollbar-width: thin;
            scrollbar-color: #9ca3af #e5e7eb;
        }
        #anatomy-list::-webkit-scrollbar {
            width: 6px;
        }
        #anatomy-list::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        #anatomy-list::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 4px;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label .toggle-dot {
            transform: translateX(100%);
        }
        .anatomy-item {
            transition: background-color 0.2s;
        }
        input[type=range].opacity-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: #d1d5db;
            border-radius: 2px;
            outline: none;
        }
        input[type=range].opacity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body class="text-gray-800 flex flex-col h-screen overflow-hidden">
    
    <header class="bg-white/80 backdrop-blur-lg flex-shrink-0 z-20 shadow-sm">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <img src="https://raw.githubusercontent.com/im2famous4u/RadMentor/main/logo.png" alt="RadMentor Logo" class="h-10 mr-3"/>
                <span class="text-2xl font-bold text-gray-800">RadMentor</span>
            </div>
            <nav class="hidden md:flex items-center space-x-8">
                <a href="#" class="text-gray-600 hover:text-blue-600">Dashboard</a>
                <a href="#" class="text-blue-600 font-semibold">Anatomy Viewer</a>
                <a href="#" class="text-gray-600 hover:text-blue-600">Courses</a>
            </nav>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Far Left Panel: Views -->
        <aside class="w-24 bg-white p-3 flex flex-col items-center space-y-4 border-r border-gray-200">
            <div class="w-full p-1 border-2 border-blue-500 rounded-md bg-black">
                <div id="view-axial" class="w-full h-20 bg-black"></div>
            </div>
            <div class="w-full p-1 border-2 border-gray-300 rounded-md bg-black">
                 <div id="view-sagittal" class="w-full h-20 bg-black"></div>
            </div>
            <div class="w-full p-1 border-2 border-gray-300 rounded-md bg-black">
                 <div id="view-coronal" class="w-full h-20 bg-black"></div>
            </div>
        </aside>

        <!-- Main Viewer (Center) -->
        <main class="flex-1 bg-black flex flex-col items-center p-2 relative overflow-hidden">
             <div id="toolbar" class="p-1.5 bg-gray-900/50 backdrop-blur-sm rounded-lg flex items-center justify-center gap-2 shadow-lg z-10 mb-2">
                <button id="anatomy-btn" class="tool-btn" title="Show Anatomy"><i class="fas fa-list-ul"></i></button>
                <button id="layout-btn" class="tool-btn" title="Switch Layout"><i class="fas fa-th-large"></i></button>
                <div class="w-px h-6 bg-gray-500"></div>
                <button id="pan-btn" class="tool-btn" title="Pan"><i class="fas fa-arrows-alt"></i></button>
                <button id="zoom-btn" class="tool-btn" title="Zoom"><i class="fas fa-search-plus"></i></button>
                <button id="ww-wc-btn" class="tool-btn active" title="Window/Contrast"><i class="fas fa-adjust"></i></button>
                <button id="reset-btn" class="tool-btn" title="Reset View"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div id="viewer-container" class="w-full flex-1 grid grid-cols-1 md:grid-cols-3 gap-2 min-h-0">
                <!-- Axial Viewport -->
                <div id="axial-column" class="flex flex-col items-center">
                    <h2 class="text-center font-semibold text-gray-300 text-sm">Axial</h2>
                    <div id="axial-viewport" class="viewport w-full h-full"></div>
                </div>
                 <!-- Sagittal Viewport -->
                <div id="sagittal-column" class="flex flex-col items-center">
                    <h2 class="text-center font-semibold text-gray-300 text-sm">Sagittal</h2>
                    <div id="sagittal-viewport" class="viewport w-full h-full"></div>
                </div>
                 <!-- Coronal Viewport -->
                <div id="coronal-column" class="flex flex-col items-center">
                    <h2 class="text-center font-semibold text-gray-300 text-sm">Coronal</h2>
                    <div id="coronal-viewport" class="viewport w-full h-full"></div>
                </div>
            </div>
             <div id="loading-indicator" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-75 text-white z-20">
                    <p>Loading DICOM Volume...</p>
            </div>
            
            <!-- Floating Anatomy Panel -->
            <div id="anatomy-panel" class="absolute top-0 left-0 h-full bg-white/95 backdrop-blur-sm p-4 w-64 shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out z-30 flex flex-col">
                <h2 class="text-lg font-semibold mb-3 pb-2 text-blue-800 border-b border-gray-200">Anatomy</h2>
                <div class="relative mb-4">
                    <input type="text" id="anatomy-search" placeholder="Search anatomy..." class="w-full bg-gray-100 border border-gray-300 rounded-md py-1.5 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div id="anatomy-list" class="flex-1 space-y-1 pr-2 overflow-y-auto"></div>
            </div>
        </main>

        <!-- Right Sidebar: Controls -->
        <aside class="w-64 bg-white p-4 flex flex-col space-y-6 overflow-y-auto border-l border-gray-200">
             <div>
                <h2 class="text-lg font-semibold mb-3 pb-2 text-blue-800">Weightings</h2>
                <div class="grid grid-cols-2 gap-2">
                    <button class="px-4 py-2 text-sm font-medium text-white rounded-md shadow-sm rad-gradient">Axial PD FS</button>
                    <button class="px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 rounded-md shadow-sm hover:bg-gray-300">Coronal T2</button>
                    <button class="px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 rounded-md shadow-sm hover:bg-gray-300">Sagittal T1</button>
                    <button class="px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 rounded-md shadow-sm hover:bg-gray-300">ABER</button>
                </div>
            </div>
            <div>
                <h2 class="text-lg font-semibold mb-3 pb-2 text-blue-800">Anatomical Parts</h2>
                <div class="space-y-3">
                    <label for="toggle-rotator" class="flex items-center justify-between cursor-pointer"><span class="text-sm">Rotator Cuff</span><div class="relative"><input type="checkbox" id="toggle-rotator" class="sr-only toggle-checkbox" checked><div class="toggle-label block bg-gray-300 w-10 h-6 rounded-full"></div><div class="toggle-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform"></div></div></label>
                    <label for="toggle-bones" class="flex items-center justify-between cursor-pointer"><span class="text-sm">Bones</span><div class="relative"><input type="checkbox" id="toggle-bones" class="sr-only toggle-checkbox" checked><div class="toggle-label block bg-gray-300 w-10 h-6 rounded-full"></div><div class="toggle-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform"></div></div></label>
                </div>
            </div>
            <!-- Settings Panel -->
            <div>
                <h2 class="text-lg font-semibold mb-3 pt-3 border-t border-gray-200 pb-2 text-blue-800">Settings</h2>
                <div class="space-y-4">
                    <label for="toggle-practice" class="flex items-center justify-between cursor-pointer"><span class="text-sm flex items-center"><i class="fas fa-question-circle w-6 text-center text-gray-500"></i>Practice</span><div class="relative"><input type="checkbox" id="toggle-practice" class="sr-only toggle-checkbox"><div class="toggle-label block bg-gray-300 w-10 h-6 rounded-full"></div><div class="toggle-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform"></div></div></label>
                    <label for="toggle-pins" class="flex items-center justify-between cursor-pointer"><span class="text-sm flex items-center"><i class="fas fa-thumbtack w-6 text-center text-gray-500"></i>Pins</span><div class="relative"><input type="checkbox" id="toggle-pins" class="sr-only toggle-checkbox"><div class="toggle-label block bg-gray-300 w-10 h-6 rounded-full"></div><div class="toggle-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform"></div></div></label>
                    <div class="space-y-2"><span class="text-sm">Overlay opacity</span><input type="range" min="0" max="100" value="75" class="opacity-slider"></div>
                    <button class="w-full flex items-center justify-between p-2 bg-gray-200 hover:bg-gray-300 rounded-md text-sm"><span class="flex items-center"><i class="fas fa-camera w-6 text-center text-gray-500"></i>Take a screenshot</span><span class="px-2 py-0.5 bg-gray-400 text-white text-xs rounded">S</span></button>
                </div>
            </div>
        </aside>
    </div>

    <script type="module">
        // Using newer, more stable versions of Cornerstone3D libraries
        import * as cornerstone3D from 'https://cdn.jsdelivr.net/npm/@cornerstonejs/core@1.86.9/dist/esm/index.js';
        import * as cornerstoneTools from 'https://cdn.jsdelivr.net/npm/@cornerstonejs/tools@1.86.9/dist/esm/index.js';
        import cornerstoneDICOMImageLoader from 'https://cdn.jsdelivr.net/npm/@cornerstonejs/dicom-image-loader@1.86.9/dist/esm/index.js';
        import cornerstoneStreamingImageVolumeLoader from 'https://cdn.jsdelivr.net/npm/@cornerstonejs/streaming-image-volume-loader@1.86.9/dist/esm/index.js';
        import dicomParser from 'https://cdn.jsdelivr.net/npm/dicom-parser@1.8.21/dist/dicomParser.min.js';

        const { RenderingEngine, Enums, volumeLoader, utilities, setVolumesForViewports, init: cs3DInit } = cornerstone3D;
        const { PanTool, WindowLevelTool, StackScrollMouseWheelTool, ZoomTool, ToolGroupManager, init: csToolsInit } = cornerstoneTools;

        const loadingIndicator = document.getElementById('loading-indicator');
        let renderingEngine;

        async function run() {
            loadingIndicator.style.display = 'flex';
            
            await cs3DInit();
            await csToolsInit();
            
            cornerstoneDICOMImageLoader.external.cornerstone = cornerstone3D;
            cornerstoneDICOMImageLoader.external.dicomParser = dicomParser;
            cornerstoneDICOMImageLoader.configure({ beforeSend: (xhr) => {} });

            const volumeLoaderScheme = 'cornerstoneStreamingImageVolume';
            volumeLoader.registerVolumeLoader(volumeLoaderScheme, cornerstoneStreamingImageVolumeLoader);

            cornerstoneTools.addTool(PanTool);
            cornerstoneTools.addTool(WindowLevelTool);
            cornerstoneTools.addTool(StackScrollMouseWheelTool);
            cornerstoneTools.addTool(ZoomTool);
            
            const toolGroupId = 'STACK_TOOL_GROUP_ID';
            const toolGroup = ToolGroupManager.createToolGroup(toolGroupId);
            
            toolGroup.addTool(WindowLevelTool.toolName);
            toolGroup.addTool(PanTool.toolName);
            toolGroup.addTool(ZoomTool.toolName);
            toolGroup.addTool(StackScrollMouseWheelTool.toolName);
            
            toolGroup.setToolActive(StackScrollMouseWheelTool.toolName);
            toolGroup.setToolActive(PanTool.toolName, { bindings: [{ mouseButton: cornerstoneTools.Enums.MouseBindings.Auxiliary }] });
            toolGroup.setToolActive(ZoomTool.toolName, { bindings: [{ mouseButton: cornerstoneTools.Enums.MouseBindings.Secondary }] });
            toolGroup.setToolActive(WindowLevelTool.toolName, { bindings: [{ mouseButton: cornerstoneTools.Enums.MouseBindings.Primary }] });
            
            const renderingEngineId = 'myRenderingEngine';
            renderingEngine = new RenderingEngine(renderingEngineId);

            const viewportIds = {
                axial: 'AXIAL_VIEWPORT',
                sagittal: 'SAGITTAL_VIEWPORT',
                coronal: 'CORONAL_VIEWPORT',
            };

            const viewElements = {
                axial: document.getElementById('axial-viewport'),
                sagittal: document.getElementById('sagittal-viewport'),
                coronal: document.getElementById('coronal-viewport'),
            };

            renderingEngine.setViewports([
                { viewportId: viewportIds.axial, type: Enums.ViewportType.ORTHOGRAPHIC, element: viewElements.axial, defaultOptions: { orientation: Enums.OrientationAxis.AXIAL } },
                { viewportId: viewportIds.sagittal, type: Enums.ViewportType.ORTHOGRAPHIC, element: viewElements.sagittal, defaultOptions: { orientation: Enums.OrientationAxis.SAGITTAL } },
                { viewportId: viewportIds.coronal, type: Enums.ViewportType.ORTHOGRAPHIC, element: viewElements.coronal, defaultOptions: { orientation: Enums.OrientationAxis.CORONAL } },
            ]);
            
            toolGroup.addViewport(viewportIds.axial, renderingEngineId);
            toolGroup.addViewport(viewportIds.sagittal, renderingEngineId);
            toolGroup.addViewport(viewportIds.coronal, renderingEngineId);
            
            const baseUrl = "https://raw.githubusercontent.com/im2famous4u/RadMentor/main/anatomy/mri-anatomy/test_shoulder/shoulder-dicom/";
            const imageIds = Array.from({ length: 280 }, (_, i) => `wadouri:${baseUrl}IMG${String(i + 1).padStart(4, '0')}.dcm`);

            const volumeId = `cornerstoneStreamingImageVolume:shoulder`;
            const volume = await volumeLoader.createAndCacheVolume(volumeId, { imageIds });
            
            volume.load();

            await setVolumesForViewports(renderingEngine, [{ volumeId }], Object.values(viewportIds));
            
            renderingEngine.renderViewports(Object.values(viewportIds));
            loadingIndicator.style.display = 'none';

            // Toolbar logic
            const toolButtons = {
                'ww-wc-btn': WindowLevelTool.toolName,
                'pan-btn': PanTool.toolName,
                'zoom-btn': ZoomTool.toolName
            };

            Object.keys(toolButtons).forEach(btnId => {
                document.getElementById(btnId).addEventListener('click', () => {
                    toolGroup.setToolActive(toolButtons[btnId], { bindings: [{ mouseButton: cornerstoneTools.Enums.MouseBindings.Primary }] });
                    document.querySelectorAll('#toolbar .tool-btn.active').forEach(b => b.classList.remove('active'));
                    document.getElementById(btnId).classList.add('active');
                });
            });
            
            document.getElementById('reset-btn').addEventListener('click', () => {
                renderingEngine.getViewports().forEach(vp => {
                    vp.resetCamera();
                    vp.render();
                });
            });
        }

        run();

        // --- UI Logic ---
        const anatomyPanel = document.getElementById('anatomy-panel');
        const anatomyBtn = document.getElementById('anatomy-btn');
        let hideAnatomyTimeout;
        anatomyBtn.addEventListener('mouseenter', () => { clearTimeout(hideAnatomyTimeout); anatomyPanel.classList.remove('-translate-x-full'); });
        anatomyBtn.addEventListener('mouseleave', () => { hideAnatomyTimeout = setTimeout(() => { anatomyPanel.classList.add('-translate-x-full'); }, 300); });
        anatomyPanel.addEventListener('mouseenter', () => { clearTimeout(hideAnatomyTimeout); });
        anatomyPanel.addEventListener('mouseleave', () => { hideAnatomyTimeout = setTimeout(() => { anatomyPanel.classList.add('-translate-x-full'); }, 300); });

        const shoulderAnatomy = [ "Humerus", "Scapula", "Clavicle", "Acromion", "Coracoid process", "Glenoid", "Supraspinatus muscle", "Infraspinatus muscle", "Teres minor muscle", "Subscapularis muscle", "Supraspinatus tendon", "Infraspinatus tendon", "Teres minor tendon", "Subscapularis tendon", "Biceps tendon (long head)", "Deltoid muscle", "Pectoralis major muscle", "Superior labrum", "Inferior labrum", "Anterior labrum", "Posterior labrum", "Acromioclavicular joint", "Glenohumeral joint", "Coracoacromial ligament" ];
        const anatomyListContainer = document.getElementById('anatomy-list');
        const anatomySearchInput = document.getElementById('anatomy-search');
        const populateAnatomyList = (filter = '') => {
            anatomyListContainer.innerHTML = '';
            const filteredAnatomy = shoulderAnatomy.filter(item => item.toLowerCase().includes(filter.toLowerCase()));
            if (filteredAnatomy.length === 0) {
                anatomyListContainer.innerHTML = `<p class="text-sm text-gray-500 p-2">No results found.</p>`;
                return;
            }
            filteredAnatomy.forEach(item => {
                const div = document.createElement('div');
                div.className = 'anatomy-item text-sm text-gray-700 p-2 rounded-md hover:bg-gray-100 cursor-pointer';
                div.textContent = item;
                anatomyListContainer.appendChild(div);
            });
        };
        anatomySearchInput.addEventListener('input', (e) => { populateAnatomyList(e.target.value); });
        populateAnatomyList();

        // Layout switcher logic
        const layoutBtn = document.getElementById('layout-btn');
        const viewerContainer = document.getElementById('viewer-container');
        const axialCol = document.getElementById('axial-column');
        const sagittalCol = document.getElementById('sagittal-column');
        const coronalCol = document.getElementById('coronal-column');
        const layoutModes = ['grid', 'axial', 'sagittal', 'coronal'];
        let currentLayoutIndex = 0;

        layoutBtn.addEventListener('click', () => {
            currentLayoutIndex = (currentLayoutIndex + 1) % layoutModes.length;
            const newMode = layoutModes[currentLayoutIndex];
            
            axialCol.style.display = 'none';
            sagittalCol.style.display = 'none';
            coronalCol.style.display = 'none';
            
            if (newMode === 'grid') {
                viewerContainer.classList.remove('grid-cols-1');
                viewerContainer.classList.add('md:grid-cols-3');
                axialCol.style.display = 'flex';
                sagittalCol.style.display = 'flex';
                coronalCol.style.display = 'flex';
                layoutBtn.innerHTML = '<i class="fas fa-th-large"></i>';
            } else {
                viewerContainer.classList.remove('md:grid-cols-3');
                viewerContainer.classList.add('grid-cols-1');
                if (newMode === 'axial') {
                    axialCol.style.display = 'flex';
                    layoutBtn.innerHTML = '<b class="text-sm">A</b>';
                } else if (newMode === 'sagittal') {
                    sagittalCol.style.display = 'flex';
                    layoutBtn.innerHTML = '<b class="text-sm">S</b>';
                } else if (newMode === 'coronal') {
                    coronalCol.style.display = 'flex';
                    layoutBtn.innerHTML = '<b class="text-sm">C</b>';
                }
            }
            // Resize the rendering engine after layout change
            renderingEngine.resize(true, true);
        });

    </script>
</body>
</html>
