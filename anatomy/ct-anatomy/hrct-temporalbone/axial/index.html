<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRCT Temporal Bone - Axial - RadMentor</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet"/>
    <style>
        body {
            font-family: 'Rubik', sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            flex-direction: column;
            overflow: hidden;
        }

        body.light-theme {
            --bg-color: #f0f8ff;
            --container-bg-color: #ffffff;
            --text-color: #333333;
            --heading-color: #0d47a1;
            --back-button-bg: #1e88e5;
            --back-button-hover-bg: #1565c0;
            --slider-track-bg: #c5d9e8;
            --slider-thumb-bg: #1e88e5;
            --annotation-text-color: #1a237e;
            --annotation-bg-color: rgba(255, 255, 255, 0.95);
            --annotation-border-color: #64b5f6;
            --annotation-line-color: #42a5f5;
            --annotation-point-color: #f44336;
        }

        body:not(.light-theme) {
            --bg-color: #004d5e;
            --container-bg-color: #043f4e;
            --text-color: #ffffff;
            --heading-color: #ffffff;
            --back-button-bg: #00bcd4;
            --back-button-hover-bg: #0097a7;
            --slider-track-bg: #032b36;
            --slider-thumb-bg: #00bcd4;
            --annotation-text-color: #e0f2f1;
            --annotation-bg-color: rgba(0, 0, 0, 0.85);
            --annotation-border-color: #00bcd4;
            --annotation-line-color: #00bcd4;
            --annotation-point-color: #f44336;
        }

        .viewer-container {
            background-color: var(--container-bg-color);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            padding: 20px;
            margin: 20px auto;
            max-width: 1550px; /* Wider to accommodate labels on both sides */
            width: 95%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .viewer-container h1 {
            color: var(--heading-color);
            font-size: 2.2rem;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* This wrapper creates the space for the right-side labels */
        .viewer-body {
            position: relative;
            width: 100%;
            max-width: 1500px; /* 1250px for image + 250px for right sidebar */
        }
        
        .image-wrapper {
            position: relative;
            width: 1250px; /* Fixed width of your image file */
            max-width: 100%;
            background-color: #000;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        .image-wrapper img {
            display: block;
            width: 100%;
            height: auto;
            user-select: none;
        }

        .annotation-svg-overlay, .annotation-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .annotation-label {
            position: absolute;
            background-color: var(--annotation-bg-color);
            color: var(--annotation-text-color);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 1px solid var(--annotation-border-color);
            z-index: 11;
            cursor: default;
            pointer-events: auto;
            white-space: normal;
            max-width: 180px;
            line-height: 1.2;
        }
        
        .annotation-label.align-right {
            transform: translate(-100%, -50%);
            text-align: right;
        }

        .annotation-label.align-left {
            transform: translate(0, -50%);
            text-align: left;
        }
        
        .annotation-svg-overlay line {
            stroke: var(--annotation-line-color);
            stroke-width: 2;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .annotation-svg-overlay line.visible-on-hover {
            opacity: 0.7;
        }
        .annotation-svg-overlay circle {
            fill: var(--annotation-point-color);
            transition: r 0.1s ease;
        }
        .annotation-svg-overlay circle.visible-on-hover-circle {
            r: 6;
        }
        
        .controls {
            width: 100%;
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        #sliceSlider {
            width: 90%;
            max-width: 1250px;
        }
        
        .back-button {
            display: block;
            width: 200px;
            margin: 40px auto 0;
            padding: 15px 25px;
            background-color: var(--back-button-bg);
            color: white;
            text-align: center;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="viewer-container">
        <h1>HRCT Temporal Bone - Axial Section</h1>
        <div class="viewer-body">
            <div class="image-wrapper">
                <img id="temporalBoneSliceImage" src="" alt="HRCT Temporal Bone Axial Slice">
                <svg class="annotation-svg-overlay" id="annotationSvgOverlay"></svg>
                <div id="annotationOverlay"></div>
            </div>
        </div>
        
        <div class="controls">
            <input type="range" id="sliceSlider" min="1" max="131" value="1">
            <div id="sliceNumberDisplay">Slice: 1 / 131</div>
        </div>

        <a href="../index.html" class="back-button">Back to HRCT Temporal Bone Menu</a>
    </div>

    <script>
        // --- CONFIGURATION ---
        const imageCount = 131;
        const imageExtension = '.jpg';
        const imageFolderPath = './images/';
        const annotationJsonPath = './annotations/';
        
        const ANATOMY_DATA_WIDTH = 850;
        const ANATOMY_DATA_HEIGHT = 532;
        const PADDING_TOP = 34;
        const PADDING_LEFT = 400;
        const IMAGE_FILE_WIDTH = 1250;
        const IMAGE_FILE_HEIGHT = 600;
        
        const LABEL_OFFSET_FROM_ANATOMY_EDGE = 20;
        const LABEL_VERTICAL_SPACING = 10;
        
        const viewerBody = document.querySelector('.viewer-body');
        const imageWrapper = document.querySelector('.image-wrapper');
        const temporalBoneSliceImage = document.getElementById('temporalBoneSliceImage'); 
        const sliceSlider = document.getElementById('sliceSlider');
        const sliceNumberDisplay = document.getElementById('sliceNumberDisplay');
        const annotationOverlay = document.getElementById('annotationOverlay');
        const annotationSvgOverlay = document.getElementById('annotationSvgOverlay');

        let allAnnotations = [];

        async function loadAnnotations() {
            try {
                const response = await fetch(`${annotationJsonPath}all_annotations.json`);
                const data = await response.json();
                allAnnotations = data.markups.flatMap(markup => 
                    markup.controlPoints?.map(cp => ({
                        slice: Math.round(cp.position[2]),
                        text: cp.label.split(/-\d+/)[0].trim(),
                        pointX_mm: cp.position[0],
                        pointY_mm: cp.position[1],
                    })) ?? []
                );
                updateSlice();
            } catch (e) {
                console.error("Error loading consolidated annotations:", e);
                alert("Could not load all_annotations.json. Please ensure the file is created correctly.");
            }
        }
        
        function updateSlice() {
            const currentSlice = parseInt(sliceSlider.value);
            temporalBoneSliceImage.src = `${imageFolderPath}${currentSlice}${imageExtension}`;
            sliceNumberDisplay.textContent = `Slice: ${currentSlice} / ${imageCount}`;

            annotationOverlay.innerHTML = '';
            annotationSvgOverlay.innerHTML = '';

            const checkOverlap = (testY, height, placedLabels) => {
                const top1 = testY - height / 2;
                const bottom1 = testY + height / 2;
                for (const label of placedLabels) {
                    if (top1 < (label.bottom + LABEL_VERTICAL_SPACING) && bottom1 > (label.top - LABEL_VERTICAL_SPACING)) {
                        return true;
                    }
                }
                return false;
            };

            temporalBoneSliceImage.onload = function() {
                this.onload = null;

                const imageDisplayWidth = this.offsetWidth;
                const imageDisplayHeight = this.offsetHeight;

                const scaleX = imageDisplayWidth / IMAGE_FILE_WIDTH;
                const scaleY = imageDisplayHeight / IMAGE_FILE_HEIGHT;
                
                const annotationsForCurrentSlice = allAnnotations
                    .filter(ann => ann.slice === currentSlice)
                    .sort((a, b) => a.pointY_mm - b.pointY_mm);

                let placedLabelsLeft = [];
                let placedLabelsRight = [];

                annotationsForCurrentSlice.forEach((annotation, index) => {
                    const x_in_anatomy = annotation.pointX_mm;
                    const y_in_anatomy = annotation.pointY_mm;
                    
                    const x_in_file = x_in_anatomy + PADDING_LEFT;
                    const y_in_file = y_in_anatomy + PADDING_TOP;
                    
                    const pX_px = x_in_file * scaleX;
                    const pY_px = y_in_file * scaleY;

                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'annotation-label';
                    labelDiv.textContent = annotation.text;
                    // Append labels to the overall viewer body, not the image wrapper
                    viewerBody.appendChild(labelDiv);

                    const labelHeight = labelDiv.offsetHeight;
                    
                    const pointIsOnLeftSide = x_in_anatomy < (ANATOMY_DATA_WIDTH / 2);
                    const targetColumn = pointIsOnLeftSide ? placedLabelsLeft : placedLabelsRight;
                    
                    let bestY = pY_px;
                    let foundFit = false;

                    if (bestY - labelHeight / 2 >= 0 && bestY + labelHeight / 2 <= imageDisplayHeight && !checkOverlap(bestY, labelHeight, targetColumn)) {
                        foundFit = true;
                    }
                    if (!foundFit) {
                        for (let offset = 10; offset < imageDisplayHeight / 2; offset += 5) {
                            let tryUp = pY_px - offset;
                            if (tryUp - labelHeight / 2 >= 0 && !checkOverlap(tryUp, labelHeight, targetColumn)) { bestY = tryUp; foundFit = true; break; }
                            let tryDown = pY_px + offset;
                            if (tryDown + labelHeight / 2 <= imageDisplayHeight && !checkOverlap(tryDown, labelHeight, targetColumn)) { bestY = tryDown; foundFit = true; break; }
                        }
                    }
                    if (!foundFit) {
                        for (let scanY = (labelHeight / 2) + 5; scanY < imageDisplayHeight - (labelHeight / 2); scanY += 5) {
                            if (!checkOverlap(scanY, labelHeight, targetColumn)) { bestY = scanY; break; }
                        }
                    }
                    bestY = Math.max(bestY, labelHeight / 2);
                    bestY = Math.min(bestY, imageDisplayHeight - labelHeight / 2);
                    
                    let labelTargetX_px, lineEndX_px;

                    if (pointIsOnLeftSide) {
                        labelDiv.classList.add('align-right');
                        const anatomyEdgeX = (imageWrapper.offsetLeft) + (PADDING_LEFT * scaleX);
                        labelTargetX_px = anatomyEdgeX - LABEL_OFFSET_FROM_ANATOMY_EDGE;
                        lineEndX_px = labelTargetX_px;
                    } else {
                        labelDiv.classList.add('align-left');
                        const anatomyEdgeX = (imageWrapper.offsetLeft) + ((PADDING_LEFT + ANATOMY_DATA_WIDTH) * scaleX);
                        labelTargetX_px = anatomyEdgeX + LABEL_OFFSET_FROM_ANATOMY_EDGE;
                        lineEndX_px = labelTargetX_px;
                    }

                    labelDiv.style.left = `${labelTargetX_px}px`;
                    labelDiv.style.top = `${bestY}px`;
                    targetColumn.push({ top: bestY - labelHeight / 2, bottom: bestY + labelHeight / 2 });

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', pX_px);
                    line.setAttribute('y1', pY_px);
                    line.setAttribute('x2', lineEndX_px);
                    line.setAttribute('y2', bestY);
                    annotationSvgOverlay.appendChild(line);

                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', pX_px);
                    circle.setAttribute('cy', pY_px);
                    circle.setAttribute('r', 4);
                    annotationSvgOverlay.appendChild(circle);

                    const activate = () => { line.classList.add('visible-on-hover'); circle.classList.add('visible-on-hover-circle'); };
                    const deactivate = () => { line.classList.remove('visible-on-hover'); circle.classList.remove('visible-on-hover-circle'); };
                    labelDiv.onmouseover = circle.onmouseover = activate;
                    labelDiv.onmouseout = circle.onmouseout = deactivate;
                });
            };

            if (temporalBoneSliceImage.complete) {
                temporalBoneSliceImage.onload();
            }
        }
        
        document.addEventListener('DOMContentLoaded', loadAnnotations);
        sliceSlider.addEventListener('input', updateSlice);
        imageWrapper.addEventListener('wheel', (event) => {
            event.preventDefault(); 
            let currentValue = parseInt(sliceSlider.value);
            if (event.deltaY > 0) {
                currentValue = Math.min(parseInt(sliceSlider.max), currentValue + 1);
            } else {
                currentValue = Math.max(parseInt(sliceSlider.min), currentValue - 1);
            }
            sliceSlider.value = currentValue;
            updateSlice();
        });
        
        document.addEventListener('keydown', (event) => {
            let currentValue = parseInt(sliceSlider.value);
            let isChanged = false;
            if (event.key === 'ArrowRight') {
                currentValue = Math.min(parseInt(sliceSlider.max), currentValue + 1);
                isChanged = true;
            } else if (event.key === 'ArrowLeft') {
                currentValue = Math.max(parseInt(sliceSlider.min), currentValue - 1);
                isChanged = true;
            }

            if (isChanged) {
                event.preventDefault();
                sliceSlider.value = currentValue;
                updateSlice();
            }
        });

        window.addEventListener('resize', updateSlice);
    </script>
</body>
</html>
